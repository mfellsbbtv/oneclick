{
  "name": "Google Workspace with Correct Nodes",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "provision-google-correct",
        "responseMode": "lastNode"
      },
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "position": [200, 300],
      "id": "webhook1"
    },
    {
      "parameters": {
        "functionCode": "// Extract and prepare user data for Google Workspace Admin node\nconst data = $input.first().json.body;\nconst employee = data.employee;\nconst config = data.config || {};\n\n// Parse full name into first and last name\nconst nameParts = employee.fullName.split(' ');\nconst firstName = nameParts[0];\nconst lastName = nameParts.slice(1).join(' ') || nameParts[0];\n\n// Generate secure temporary password\nconst tempPassword = 'Welcome' + Math.floor(Math.random() * 10000) + '!@#';\n\nreturn [{\n  json: {\n    requestId: data.requestId,\n    // User data for Google Workspace Admin \"Create a user\" action\n    primaryEmail: employee.workEmail,\n    firstName: firstName,\n    lastName: lastName,\n    fullName: employee.fullName,\n    password: tempPassword,\n    orgUnitPath: config.primaryOrgUnit || '/',\n    department: employee.department || '',\n    jobTitle: employee.jobTitle || '',\n    phone: employee.phone || '',\n    // Additional data for processing\n    tempPassword: tempPassword,\n    groups: config.groups || [],\n    originalData: data\n  }\n}];"
      },
      "name": "Prepare User Data",
      "type": "n8n-nodes-base.function",
      "position": [400, 300],
      "id": "prepare1"
    },
    {
      "parameters": {
        "resource": "user",
        "operation": "create"
      },
      "name": "Create a user",
      "type": "n8n-nodes-base.googleWorkspaceAdmin",
      "position": [600, 300],
      "id": "createUser1",
      "continueOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "conditions": [
            {
              "value1": "={{ $json.id }}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "name": "User Created?",
      "type": "n8n-nodes-base.if",
      "position": [800, 300],
      "id": "checkSuccess1"
    },
    {
      "parameters": {
        "conditions": {
          "conditions": [
            {
              "value1": "={{ $('prepare1').first().json.groups.length }}",
              "value2": 0,
              "operation": "greaterThan"
            }
          ]
        }
      },
      "name": "Has Groups?",
      "type": "n8n-nodes-base.if",
      "position": [1000, 200],
      "id": "hasGroups1"
    },
    {
      "parameters": {
        "functionCode": "// Split groups for individual processing with \"Add user to group\" action\nconst groups = $('prepare1').first().json.groups;\nconst userEmail = $('prepare1').first().json.primaryEmail;\nconst createdUser = $('createUser1').first().json;\n\nif (!groups || groups.length === 0) {\n  return [];\n}\n\n// Return each group as a separate item for Google Workspace Admin \"Add user to group\" action\nreturn groups.map(groupEmail => ({\n  json: {\n    groupId: groupEmail,\n    userEmail: userEmail,\n    userId: createdUser.id\n  }\n}));"
      },
      "name": "Split Groups",
      "type": "n8n-nodes-base.function",
      "position": [1200, 150],
      "id": "splitGroups1"
    },
    {
      "parameters": {
        "resource": "user",
        "operation": "addToGroup"
      },
      "name": "Add user to group",
      "type": "n8n-nodes-base.googleWorkspaceAdmin",
      "position": [1400, 150],
      "id": "addToGroup1",
      "continueOnFail": true
    },
    {
      "parameters": {
        "functionCode": "// Format successful user creation with groups\nconst originalData = $('prepare1').first().json;\nconst userCreation = $('createUser1').first().json;\n\n// Process group results from \"Add user to group\" actions\nlet groupResults = [];\ntry {\n  const groupItems = $('addToGroup1').all();\n  groupResults = groupItems.map((item, index) => {\n    const success = item.json && !item.json.error;\n    return {\n      group: originalData.groups[index] || 'unknown',\n      status: success ? 'added' : 'failed',\n      error: !success ? (item.json?.error?.message || 'Unknown error') : null\n    };\n  });\n} catch (e) {\n  // No groups processed\n}\n\nconst failedGroups = groupResults.filter(g => g.status === 'failed').length;\nlet status = 'success';\nlet message = 'Google Workspace user created successfully';\n\nif (failedGroups > 0) {\n  status = 'partial';\n  message = `User created but ${failedGroups} group(s) failed`;\n}\n\nreturn [{\n  json: {\n    appName: 'googleWorkspace',\n    requestId: originalData.requestId,\n    result: {\n      status: status,\n      userId: userCreation.id,\n      primaryEmail: userCreation.primaryEmail,\n      message: message,\n      details: {\n        user: {\n          id: userCreation.id,\n          primaryEmail: userCreation.primaryEmail,\n          name: userCreation.name,\n          orgUnitPath: userCreation.orgUnitPath,\n          suspended: userCreation.suspended\n        },\n        orgUnit: userCreation.orgUnitPath,\n        groups: groupResults,\n        temporaryPassword: originalData.tempPassword,\n        created: userCreation.creationTime || new Date().toISOString()\n      }\n    }\n  }\n}];"
      },
      "name": "Success with Groups",
      "type": "n8n-nodes-base.function",
      "position": [1600, 150],
      "id": "successGroups1"
    },
    {
      "parameters": {
        "functionCode": "// Format successful user creation without groups\nconst originalData = $('prepare1').first().json;\nconst userCreation = $('createUser1').first().json;\n\nreturn [{\n  json: {\n    appName: 'googleWorkspace',\n    requestId: originalData.requestId,\n    result: {\n      status: 'success',\n      userId: userCreation.id,\n      primaryEmail: userCreation.primaryEmail,\n      message: 'Google Workspace user created successfully',\n      details: {\n        user: {\n          id: userCreation.id,\n          primaryEmail: userCreation.primaryEmail,\n          name: userCreation.name,\n          orgUnitPath: userCreation.orgUnitPath,\n          suspended: userCreation.suspended\n        },\n        orgUnit: userCreation.orgUnitPath,\n        groups: [],\n        temporaryPassword: originalData.tempPassword,\n        created: userCreation.creationTime || new Date().toISOString()\n      }\n    }\n  }\n}];"
      },
      "name": "Success No Groups",
      "type": "n8n-nodes-base.function",
      "position": [1200, 250],
      "id": "successNoGroups1"
    },
    {
      "parameters": {
        "functionCode": "// Handle user creation failure\nconst originalData = $('prepare1').first().json;\nconst userCreation = $('createUser1').first().json;\nconst error = userCreation.error || 'Unknown error';\n\nreturn [{\n  json: {\n    appName: 'googleWorkspace',\n    requestId: originalData.requestId,\n    result: {\n      status: 'error',\n      userId: null,\n      primaryEmail: originalData.primaryEmail,\n      message: 'Failed to create Google Workspace user',\n      details: {\n        user: null,\n        orgUnit: originalData.orgUnitPath,\n        groups: [],\n        temporaryPassword: null,\n        created: null\n      },\n      error: {\n        message: error.message || 'User creation failed',\n        details: error\n      }\n    }\n  }\n}];"
      },
      "name": "Handle Error",
      "type": "n8n-nodes-base.function",
      "position": [1000, 400],
      "id": "handleError1"
    }
  ],
  "connections": {
    "webhook1": {
      "main": [
        [
          {
            "node": "prepare1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "prepare1": {
      "main": [
        [
          {
            "node": "createUser1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "createUser1": {
      "main": [
        [
          {
            "node": "checkSuccess1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "checkSuccess1": {
      "main": [
        [
          {
            "node": "hasGroups1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "handleError1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "hasGroups1": {
      "main": [
        [
          {
            "node": "splitGroups1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "successNoGroups1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "splitGroups1": {
      "main": [
        [
          {
            "node": "addToGroup1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "addToGroup1": {
      "main": [
        [
          {
            "node": "successGroups1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  }
}